# オニオンアーキテクチャを学ぶ

## 課題1
> オニオンアーキテクチャを図解してください

<img src='https://i0.wp.com/jeffreypalermo.com/wp-content/uploads/2018/06/image257b0257d255b59255d.png?resize=366%2C259&ssl=1'>

出典：Jeffrey Palermo, "The Onion Architecture: part1," 2008

ソフトウェアの構造を責務ごとにレイヤー化し、各モジュールの依存関係・結合度をコントロールすることを目的とした設計思想のこと。
依存関係・結合度をコントロールすることにより、ソフトウェアの**保守性の向上**、**テスト容易性の向上**、**再利用性の向上**が実現できる。
分割するレイヤーの種類は図で示す通り、以下の4層に分けられる。

1. インフラストラクチャ層<br>
円の最も外側に位置する層であり、DBへのアクセス（データの永続化や取得）、外部サービス、ログ出力などの外部要素とのやり取りを担当する。
しばしば変更される可能性が高い**ユーザーインターフェース**（Controller、API）やテストなどもこの層に該当する。

2. アプリケーションサービス層<br>
アプリケーション固有の振る舞いを実装する層。
**ユースケース**とも呼ばれ、要求を満たすために複数のドメインモデルやドメインサービスを操作することで結果を返却する。
この層の〇〇Serviceクラス自体にビジネスロジックは書かれない。

3. **ドメインサービス**層<br>
ドメインモデルに直接関連する操作や複数のドメインモデルにまたがる操作を提供する層。
ドメインモデルがシステム化対象概念の実態をクラスで表現したものに対して、実体のないものがドメインサービスに当たる（ドメインモデルが保有するには違和感のある振る舞いではあるが、ビジネス上必要な一連の処理など）。
主にドメインロジックとビジネスルールを保持しており、DBアクセスのためのインターフェースなどがこの層で定義される。
（この層のインターフェースをインフラストラクチャ層のクラスが実装することで具体的なDB読み書きなどが行われる）

4. **ドメインモデル**層<br>
円の最も中心に位置する層であり、ドメイン（システム化対象の業務知識）をモデル化したデータと振る舞いの組み合わせによって構成される。
データベースやWebAPIなどの具体的な技術要素から独立されている。
具体的には、``Entity``や``ValueObject``が当てはまる。
アプリケーションサービス層からドメインモデル層はまとめて**アプリケーションコア**とも呼ばれる。

<img src='https://i0.wp.com/jeffreypalermo.com/wp-content/uploads/2018/07/theonionarchitecturepart3_67c4image05.png?resize=376%2C263&ssl=1'>

出典：Jeffrey Palermo, "The Onion Architecture: part2," 2008
  
また基本的な原則としては、
図の外側のレイヤーから内側のレイヤーへのみ依存することが許されている。
（例えば、ドメインモデルは円の最も中心に存在しているため、周辺レイヤーはドメインモデルへの依存が許されているが、ドメインモデルはそれらの周辺レイヤーへ依存することは許されていない）
基本的に変更されることが少ないビジネスルールが、頻繁に変更される要素によって影響を受けづらくすることができる。
  
> 中心に位置するドメインモデル層は他のどの層にも依存していません。こうすることに、どのようなメリットがあるのでしょうか？

ドメインモデル以外の層に修正が発生したとしても基本的に影響を受けることがないため、変わってほしくないビジネス上の重要ルール・概念を守ることができる。

> 層をまたいで依存関係が発生する時（例えばユースケース層がレポジトリ層のメソッドを呼び出す時など）はインターフェースに対する依存のみ許可します。こうすることに、どのようなメリットがあるのでしょうか？

- インフラストラクチャ層に該当する実装クラスの変更（DBを変えるとか、保存方法自体を変えるとか）があってもアプリケーションコアの部分に影響を与えずに済む。
- モックを挿入しやすくなるため、テストが容易になる。
    - インフラストラクチャなどの具体的な実装がまだできていなくても開発を進めることができる。

> 「依存性の逆転」がオニオンアーキテクチャにおいてどのように使われているのか説明してください

依存性の逆転は、伝統的なアーキテクチャ構造で見られる上位モジュールが下位モジュールに依存する構造に対して、下位モジュールが上位モジュールへ依存するような構造にする原則である。
オニオンアーキテクチャでは、上位モジュールが図で示した円の中心の層にあたり、インフラストラクチャ層などの下位モジュールがドメインモデル層やドメインサービス層にあるインターフェースを実装する形をとる。
ドメイン層は、インターフェースを通じてインフラストラクチャ層を利用することができるため、具体的な実装の詳細を知る必要がなく、「依存性の逆転」のメリットを享受することができる。

> 特定のユーザにしかリソースの追加や更新を許さないようなアクセス制限機能を実装したいとします。どの層に記述するのが適切でしょうか？

ユーザのアクセス権限を確認するという処理はアプリケーション固有の機能だと思われるため、アプリケーション層。
ユーザからリクエストを受け取るのはアプリケーション層にあるモジュールであり、そのモジュール内でドメインが持つビジネスロジックを呼び出すことでユースケースを満たすため、ドメイン側にアクセス制御のロジックがあると、ドメインの持つビジネスロジックの責務が増えてしまう恐れがある。また、ビジネスロジックをテストする際に、セキュリティも合わせてテストを作成する必要が出てきたり、アクセス権限範囲が変更された際に、ドメイン側を修正する必要が出てくる。

> データベースをMySQLからPostgreSQLに変更するとします。どの層を変更する必要があるでしょうか？

主にインフラストラクチャ層。
どのDBを選択するか…などのアプリケーションの要件を実現するための具体的な技術に関しては、アプリケーションコアの部分に依存しないように設計されているため。

## 参考資料
- [The Onion Architecture: part 1](https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/)

## 課題2
### オニオンアーキテクチャに関するクイズ

1. オニオンアーキテクチャの適用が向いているアプリケーションにはどのような特徴がありますか？


- ドメインモデルが複雑で、それに伴いビジネスルールも多岐にわたるようなアプリケーション。
- 長いライフサイクルが想定されており、メンテナンスをし続けることが前提のアプリケーション。
    - ビジネスルールや技術的な要素のアップデートが必要だと予想されるもの。

    逆に言えば、小規模かつビジネスロジックが単純なものであったり、短期間での使用が予定されているアプリケーションである場合は、過剰な設計になってしまい開発に時間がかかってしまう（=工数に見合ったリターンが得難い）。

2. アプリケーションサービス層には具体的にどのようなモジュールが書かれますか？


- ドメイン層（ドメインモデル層＋ドメインサービス層）のビジネスロジックを使って具体的なユースケースを実行するクラスが配置される。
    - ドメイン層が提供するメソッドを呼び出し、アプリケーション固有のデータ処理を行う。
    - トランザクションの管理や、エラーチェック、セキュリティチェックなど、アプリケーションの実行を制御する責務もある。


3. レイヤードアーキテクチャとオニオンアーキテクチャの特徴の違いを説明してください。


- レイヤードアーキテクチャは、一般的に各層が直下の層にのみ依存し、下位層から上位層へ依存は発生しない。これに対して、オニオンアーキテクチャは、外側の層から内側にあるどの層にも依存することができる。

    <img src='https://i0.wp.com/jeffreypalermo.com/wp-content/uploads/2018/07/theonionarchitecturepart3_67c4image07.png?resize=376%2C240&ssl=1'>

    出典：Jeffrey Palermo, "The Onion Architecture : part 3" 2008