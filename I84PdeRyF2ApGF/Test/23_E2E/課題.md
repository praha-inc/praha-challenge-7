# E2Eテスト

# メモ
## E2Eテストとは？
ユーザーの実際の利用環境に基づき、システムが正しく動作するかデータフローが適切に機能するかどうかを検証するテスト。
Webサービスの場合、ユーザと同じようにブラウザを操作し、期待通りの挙動になるかを確認する。
例：ログインページのシナリオ
1. ログイン画面を表示
2. メールアドレスを入力
3. パスワードを入力
4. ログインボタンを押下
5. トップページに遷移する
個別の機能を検証する単体テストなどと異なり、ネットワークやファイル、DBアクセスなども含まれるため、それまでのテストでは検出できない、外部との通信が発生することで正しく動作しないといった不具合も検出可能。
大半のE2Eテストは、テスト仕様書をベースに手動で行われている。
  
## Cypressとは？
JavaScriptで構成されたオープンソースのフロントエンドツール。
- 単体テストからE2Eテストまで広く使える。
- テスト構築、実行、バグ検知まで全て行える。
- コマンドごとに画面のスナップショットを見返せる。
- テスト一連の様子をビデオとして保存できる。
- 各種CIとの連携が可能である。

### 参考
- https://circleci.com/ja/blog/what-is-end-to-end-testing/ 
- https://adoc-teslab.com/blog/automated-e2e-test-accelerates-quality-assurance/24582/
- https://ops.jig-saw.com/tech-cate/e2e_cypress
- https://future-architect.github.io/articles/20210428a/

# 課題１
以下のPRにて実装しております。  
https://github.com/hira-kenta/tic-tack-toe/pull/4

# 課題２
> E2Eテストのメリットとデメリットを挙げてください

## メリット
1. 実際に顧客が取りうる操作による結果を検証できるため、単体テスト等では検出できなかった、システム全体を通してユーザーの期待に応えられる機能を提供できているかを確認できる。
2. UIレイヤー（フロントエンド）、APIレイヤー（バックエンド）、サードパーティシステム（RDBとかクラウドサービスとか）などで構成されるアプリケーションに関して、各コンポーネントが互いに連携して機能することが確認できる。（テストでカバーできる範囲が広い）
3. ブラウザ、デバイスによる互換性の問題を検出することができる。

## デメリット
1. サーバーやブラウザを起動するため、テスト実行に時間がかかる。
2. サーバーにアクセスするため、ネットワークの影響や環境が影響してテストが落ちたりするため、結果が不安定になりがち。
3. 中途半端なテストデータが残ってしまう
    - ログインが失敗したらアカウントがロックされるという機能をテストした場合、ロックされたままでテストが終了してしまうとその他のテストケースに影響が出てしまう恐れがある（テスト実行前に初期化するなどの工夫が必要）。システム全体を動かして行うテストだからこそ影響がでる。

> テスト手法（単体、統合、E2Eなど）を選択する際、どのような基準で選ぶと良いでしょうか？
- 単体テスト
    - 個別のコンポーネント、関数がテスト対象。
    - 入力に対して期待通りの値が得られるかどうかというプログラムが果たすべき最低限の機能の評価、保証を行う。
    - 各機能が組み合わさった時に正しく動作するかの確証は得られない。
- 統合テスト
    - コンポーネント間の連携や相互作用がテスト対象。
    - コンポーネント間でデータの受け渡しや連携が正常に行われているかの確認を行う。
- E2Eテスト
    - アプリケーション全体を通しての機能やユーザビリティがテスト対象。
    - ユーザーの操作をシナリオとして再現し、各操作に対して期待通りにシステムが機能するかを確認する。

- 「実行時間、コスト」という基準では、「単体＞統合＞E2E」
- 「信頼性（システムが本番環境で安定して動作するか？）」という基準では、「E2E＞統合＞単体」
    - E2Eは、本番環境に近い環境下かつ、利用シナリオのテストになるため、信頼性が高いテストと言える（単体や統合は環境や扱うデータが擬似的なものになってしまう）。
- 「網羅性」という基準では、「単体＞統合=E2E」
    - 単体テストは、システムの最も細かい単位でのテストを制御できるうえ、UIからの操作による入力以外のケースもテストを行うことができるため網羅性が高いと言える。

> E2Eテストでは要素（ボタンや文言など）を選択する必要が生じますが、要素を選択する上で少し注意が必要です。

- classを識別子に使う時の注意点
    - 複数の要素が同じクラスを共有している場合があるため、`cy.get('.red-button').click()`では特定の要素に絞り込むことができない恐れがある。

- idを識別子に使う時の注意点
    - idを識別子で使用すると、idの変更を伴う修正がプロダクト側で発生した際に、テストが壊れてしまう。
        - テストコードで参照しているから…という理由に縛られて、idの変更を伴うリファクタリングを行いづらくなってしまう。

- 要素の文言を識別子に使う時の注意点
    - `cy.contains("送信する").click();`で「送信する」ボタン押下時の挙動をテストしたい場合…。同じページ内に「送信する」ボタンが複数存在する可能性があるため、どのボタンをクリックするか明示的にする必要がある。
        - 「送信する」などシステムを通してよく使われるコンポーネントを指定する場合は注意する、

### 参考
- https://qiita.com/NAKKA-K/items/58d6b8476a3717179bda
- https://www.praha-inc.com/lab/posts/e2e-testing
- https://www.accelq.com/blog/what-is-end-to-end-e2e-testing/
- https://blog.american-technology.net/what-is-end-to-end-testing/
- https://qiita.com/shinnosuke0522/items/5a330a6eca6714c61de8

## ロケータについて
- E2Eテストにおいて、操作や検証の対象となる要素を指定するためのキーのこと。CSSセレクタなどが利用でき、`id`、`class`、`name`といった属性を利用するのが一般的。
- 要素を一意に指定できれば問題ないが、保守性を考慮すると以下のような条件を満たすことが望ましい。
    - 常に一意である。
    - 変更される可能性が少ない。

- Cypressでは、`data-*`属性というカスタム属性を使用するのを推奨している（CSSやJSの変更の影響を受けないようにするという意図）。
    - これによりプロダクトコード側のリファクタリングによってE2Eテストが壊れるのを防ぐことができる。
    - 定義した`data-*`属性をプロダクトコード側で一意性が保たれるように適切に管理する必要は出てくる。

### 参考
- https://autify.com/ja/blog/why-id-should-not-be-used

# 課題3
以下のPRにて実装しております。  
https://github.com/hira-kenta/tic-tack-toe/pull/5

# 課題４
1. Cypress以外にE2Eテストを自動化するためのツールとしてSeleniumというツールがあります。CypressとSeleniumの違いにはどんなものがありますか？

- Seleniumとは…？
    - Webブラウザの操作を自動化するためのフレームワーク。
        - 起動するためには必ずWebブラウザとWeb driverが必要。
        - Web driverを介することで、ブラウザの外からネットワークを利用してブラウザ操作が行われる。
    - Webクローリングや、タスクの自動化などにも使われる。
    - Javascriptだけではなく、Java、Ruby、Pythonなどの様々な言語やフレームワークを使用できる。
    - Safariを含む様々なブラウザが対象。

- 主な違い
    1. 対応言語
        CypressはJavaScriptのみで記述できるのに対し、SeleniumはPython、Javaなど複数の言語、フレームワークでテストを書くことができる。
    2. 環境構築
        CypressはCypressのみインストールすればテストを作成する環境が整うのに対し、SeleniumはSelenium以外にもWeb driverを別途インストールする必要がる。
    3. 用途
        Cypressは自動テストの用途に特化しており、標準でリクエストや要素の表示を待機してくれたり、デバッグ機能がサポートされていたりする。Seleniumはブラウザを自動操作するツールであり、スクレイピングや定型操作の自動化などでも活用することができる。
    4. アーキテクチャ
        Cypressは、ブラウザの裏でNode.jsのプロセスが動いており、ブラウザ内部から直接テストを実行できるため、実行速度が早く、ネットワークのリクエストレスポンスもモック化することができる。Seleniumは、Web driverを経由してブラウザを操作しテストを実行する。通信が発生するため、実行速度が遅くなることがある。

    参考
    - https://www.kaizenprogrammer.com/entry/2017/12/23/144242
    - https://labfor310.tistory.com/7
    - https://azukiazusa.dev/blog/e2e-cypress/#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B
　　

2. Cypressでは`cy.visit('http://localhost:3000/index.html)`で、テスト対象のページを開くことができます。ただ例のような完全修飾名を各テストケースに書いていては少し冗長です。どんな工夫で解決できそうですか？

- baseUrlとして、`cypress.config.js`に設定を追加する。
    ```
    const { defineConfig } = require('cypress')

    module.exports = defineConfig({
    e2e: {
        baseUrl: 'http://localhost:3000',
    },
    })
    ```
  - baseUrlを設定すると、`cy.visit('index.html')`と単純化することができる。
  - その他のメリットとして、異なる環境やドメイン間でテストを切り替えて実行するのが容易になる(localhostと運用サーバーとか…)。
    - baseUrlを設定していないと環境ごとで`cy.visit()`に渡すURLを変更する必要が出てくる。
    
3. Cypressで使用されるAliasについて説明してください。

- テストコード内でDOM要素やアクションに対して名前を付け、それをテストコード内で再利用できるようにする機能のこと。
  - 可読性の向上や記述が冗長にならないようにすることが目的で導入される。
  - テスト上で何度も出てくるような決まった操作をAliasを

- 使用例
  ```
  // 要素に対してasで名前をつける
  beforeEach(() => {
    cy.get('input[name="username"]').as('usernameInput');
    cy.get('button[type="submit"]').as('submitButton');
  })
  
  // @を先頭につけてasで命名した名前を指定することで要素が特定される
  // テストケース内で繰り返し使用する要素はこの指定の仕方で記述が楽に…なるかも！
  cy.get('@submitButton').click();

  // コマンド(操作)に対してasで名前をつける
  // ↓　ChatGPTで生成したコード
  Cypress.Commands.add('login', (username, password) => {
    cy.get('input[name="username"]').type(username);
    cy.get('input[name="password"]').type(password);
    cy.get('button[type="submit"]').click();
  }).as('loginCommand');

  // エイリアスを呼び出すことで操作を簡潔に記述することができる
  cy.get('@loginCommand')('userName', 'password')
  ```

  参考
  - https://docs.cypress.io/guides/references/best-practices