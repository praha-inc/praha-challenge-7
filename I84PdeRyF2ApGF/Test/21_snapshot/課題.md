# スナップショットテスト

## 課題１

> スナップショットテストとはなんでしょうか？説明してください

コンポーネントなどにより生成されるUIに関して、変更前の出力結果と変更後の出力結果の間に、差分がないことを確認するテスト。
簡単に言えば「画面レイアウトのテスト」。
具体的には、テストが初回実行される際に、コンポーネントや画面の状態がキャプチャされ、それをスナップショットとしてシリアライズして保存する。
そして、次にテストが実行される際に、現在の画面の状態が再度シリアライズされ、前回実行時のスナップショットとの比較が行われる。
スナップショットテストを導入することで、ロジックを修正した際の意図しないレイアウトの変更の発生を検出することができる。
（毎回これを画面キャプチャ撮ってテストしていては大変…）

> スナップショットテストを用いることで、どのような不具合が防止できるでしょうか？3つほど具体的な例を挙げてみてください

1. コンポーネントの表示において、表示自体は変更せずパフォーマンス向上させることを目的に、リファクタリングを行った。簡単に画面で表示を見たところ問題が無さそうだったためスナップショットテストを実行したところテストが失敗した。調べると、自分が画面を起動して確認したケース以外のケースにおいて、意図せず表示が変わっていることが判明した。
2. バックエンド側の実装を行っているチームがAPIの修正を行い、レスポンスデータの一部を変更した。API側の単体テストはパスしたため問題がないかと思われたがスナップショットテストで失敗した。原因はAPIのレスポンスデータが変更されたことにより、コンポーネント側で受け取って表示するデータが変わってしまったからであった。
3. フロントエンドのフレームワークにAngularを使用していたが、Reactに移行することにした。Angularの時のコンポーネントのスナップショットと、Reactに書き換えたコンポーネントのスナップショットを比較することで、移行が問題なく行われているかを検証した。

> スナップショットテストでは防止できない不具合もあります。3つほど具体的な例を挙げてください

1. ソースを修正したことによりコンポーネントが表示されるまでの時間が長くなるようなパフォーマンス悪化。
2. 表示は想定通りにできているが、コンポーネントに設定されているイベント処理（入力、クリックイベント等）が発火しないという不具合。
3. CSSなどのコンポーネントのソース以外で変更が起き、予期しないレイアウトのスタイルの変更が発生したという不具合。

## 課題２
[実装したリポジトリ](https://github.com/hira-kenta/storybook_sample/pull/2)

### テスト実行内容

- 初回実行時
![テスト結果](/21_snapshot/screenshots/テスト結果画面.png)  

- コンポーネントの内容を変更してテスト実行
![テスト失敗画面](/21_snapshot/screenshots/テスト失敗画面.png)

ターミナル上で`u`を入力したらスナップショットが更新され、次回以降そのスナップショットが基準となり、差分検出が行われる。


> 作成されたスナップショットを見てみましょう。どんな情報が記載されているでしょうか？

以下のように各コンポーネントで表示される内容がHTML要素になって記載されている。
```
    exports[`Storyshots tic-tac-toe/Board Default 1`] = `
    Array [
    <div
        className="status"
    >
        次のプレイヤー: X
    </div>,
    <div
        className="board-row"
    >
        <button
        className="square"
        onClick={[Function]}
        />
        <button
        className="square"
        onClick={[Function]}
        />
        <button
        className="square"
        onClick={[Function]}
        />
    </div>,......

```

## 課題３

### 問題
1. スナップショットテストとよく似たテストにビジュアルリグレッションテストがありますが、両者の違いは何ですか？ 
2. スナップショットテストでは、CSSファイルなどによるコンポーネント外部のファイルからのスタイリングの変更は検知することができません。この問題の解決策には何がありますか？
3. Storyshotsを設定する関数である`initStoryshots()`は、引数としてStoryshotsの動作をカスタマイズするためのプロパティを持つ設定オブジェクトを受け取ります。設定できるプロパティを3つ答えてください。

### 解答
1. ビジュアルリグレッションテストもUIをテストする手法であるが、比較対象が異なる。ビジュアルリグレッションテストは、ページのスクリーンショットを取得し、出力された画像をピクセル単位で比較するのに対して、スナップショットテストは、コンポーネントの出力に際して生成されるDOM要素などをシリアライズした値をテキストファイルに格納して比較が行われる。ビジュアルリグレッションテストの方がCSSの変更を検知したり、より見た目を重視したテストであると言える。
2. 
 - CSS-in-JSを使用してコンポーネントにスタイリングを設定することで、スタイル情報もコンポーネントの一部としてスナップショットを取得できる。
 - `@storybook/addon-storyshots-puppeteer`を利用してスナップショットイメージによる差分比較を行うようにする。
3. 
- `suite` : ストーリーのテストスイートの名前を指定できる。テスト結果の出力などで使用される。
- `framework` : Storyshotsのテスト対象となるフレームワーク(React, Vue, Angularなど)を指定する。デフォルトは、`"resct"`が使用されている。
- `test` : ストーリーごとにカスタムテスト関数を設定できる。このプロパティでっ設定した`addon-storyshots-puppeteer`などのテストランナーが、各ストーリーごとに実行されるようになる。

  
### 参考
https://tarosky.co.jp/tarog/4662  
https://developer.mamezou-tech.com/testing/jest/jest-snapshot-testing/  
https://www.gaji.jp/blog/2020/02/13/2532/  
https://developers.cyberagent.co.jp/blog/archives/29784/  
https://storybook.js.org/docs/react/writing-tests/snapshot-testing  
