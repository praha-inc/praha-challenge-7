# データベース設計のアンチパターンを学ぶ７

## 課題１
- 退会していないユーザーを抽出したい際に、`where taikaiFlag = false`の条件をつける必要があるため、つけ忘れによるバグが起きる可能性がある。
  - 課題では、単一テーブルだけが対象であるため、そこまで問題はないかも知れないが、その他のテーブルでも同様に論理削除フラグがついており、複数テーブルを結合しなければならない場合などで、上記のような問題が起きる可能性が高い。
- システム上必要のないデータが蓄積されていくことになるため、それに伴いデータ量が肥大化し、パフォーマンスに影響を及ぼす可能性がある。
- taikaiFlagというカラムで退会しているかどうかを判断する場合、そのユーザーが自ら退会をしたのか、システムにより強制退会されたのか…など、退会という状態にいたるまでの経緯が分からない（もしその情報が必要なのであればですが…）。

## 課題２
### 解決策
- 論理削除フラグを持たせず、退会ユーザーは物理削除で対応する。
- 退会というイベントをテーブルに切り出す。ユーザーが退会しているかどうかは、退会テーブルと紐づけることで判断する。

[ER図](./ER%E5%9B%B3.md)

- 今回は二つ目の退会イベントテーブルに切り出す例を作成。
  - パフォーマンス面でのデメリットは残るが、実際の業務に即したエンティティが作成できる。

## 課題３
### ECサイトでの注文を取り消す機能の実装において、Orderテーブルからid指定で注文を物理削除する場合の懸念…
- 注文によって発生する在庫引き当てや出荷業務などのデータが、Orderテーブルのidと紐づいている場合、関連業務のテーブルにも影響が出てしまう。
  - 物理削除を前提に外部キー制約や物理削除時の関連テーブルが設計されていればいいが、考慮されていないのに物理削除が採用されてしまうと、CASCADEによって想定されていないレコードが削除されてしまったり、DBの整合性が取れなくなってしまう可能性がある。
- 注文したという事実がデータ上なくなってしまうため、ちゃんと注文が取り消されているということを確認することができないためユーザーが不安に感じる恐れがある。
  - 「Aを⚪︎月×日に注文したけど、⚪︎月△日にキャンセルをした」ということが参照できる方が安心。
- 注文が取り消されるケースには、お客様側からの申し出だけでなく、注文されたが入金されずシステム側で取り消す、一時的に欠品してしまい店舗都合で取り消すというケースもある。
  その際に物理削除されてしまうと、どの注文がどのような理由でキャンセルされたのか分からない。
  - 注文がキャンセルされた理由から業務改善案が見えてくることもあるかも…
    - 間違えて注文してしまいやすい説明、UIなのかも…とか在庫管理システムついて見直した方がいいかも…とか

### 学習塾の進捗管理サービスでの生徒の退会機能実装において、Studentテーブルからid指定で物理削除する場合の懸念
- どのような生徒がどんな学習をして成績を上げたのかなどの情報が参照できなくなる。
  - 退会が発生するケースとして、受験に合格して卒業するケースが考えられる。成績を上げることができたモデルケースを分析することが学習塾にとっては必要。

### 過去の開発の中で物理削除を採用したケース
- 転職したてのころ社内の書籍管理サービスを練習で作ってみようということになり、
  論理削除という言葉もろくに知らなかったので、書籍が廃棄された場合に物理削除するようにしていた。
  - レビューしてもらう中で、論理削除という概念を教えてもらって削除フラグの存在を知ったため、削除フラグカラムをつけた。
  - 物理削除されてしまった場合に、関連するテーブルに影響がでてしまうからというのが主な理由であった。
  
- 物理削除、論理削除のどちらがいいのかというよりも実際の業務に照らし合わせたり、仕様を把握した上で選択することが大切。
　（とりあえず…で削除方法を決めると後々大変なことになる）

## メモ
- なぜ論理削除が必要なのか？
  - アプリケーションの利用上必要ないが、データとして残しておきたい。
    - システム側で一時的にデータを使用禁止にし、確認後すぐに戻したいというケース。
    - 誤ってデータを削除してしまった場合に、すぐにデータを復元したい。
    - データをログとして残しておきたい。
  - 削除されたデータを閲覧・復活させるという業務が存在する。
