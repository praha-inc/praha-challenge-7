# マルチテナントについて

## 課題１
- コードレビューができなかったことに対する対策
  - 自動テストを導入することで、最低限のテストはされるような状態を作る。
  - この書き方をしたら大変なことになるという最悪のケースを避けるためのチェックリストを作成し、新人でも安全なプログラムが作成できるようにする。
  - コードレビューを外注する（ランサーズにいるフリーランスの方でそのような仕事を募集している人がいた）
- 誤ったコードを書かれないようにする対策
  - テナントごとにビューを作成し、データの取得は元テーブルからではなく、ビューから取得するように実装方針を統一する。
  - テナントごとにデータベースを分けた設計にすることで、クエリの記述ミスで意図しないデータ操作が行われることを防ぐ。

## 課題２
### テナント毎にデータベースを分割する
- メリット
  - テナントごとに接続するDBを切り替える必要があるため、意図しないデータの読み書きが発生しにくくなる。
  - あるテナントのデータベースで障害が発生した場合でも、他テナントへ影響が及ぶことを防ぐことができる。
  - テナントに応じて独自の設定・構成を行えたり、関数の作成などを行うことができる。

- デメリット
  - 運用コストが高くなる。
  - テナントを跨いだデータの取得が難しい。
  - 全テナントに対して共通したデータモデルの変更があった場合、各テナントのデータベースに対してマイグレーションを行う必要があり大変。

### テナント毎にスキーマを分割する
- メリット
  - データベースを共有できるため、ハードウェアリソースやストレージを効率的に利用できる。
  - テナントの情報がスキーマで分離されているため、個別テナントのデータモデル、テーブル構造を変更しても他のテナント、データベース全体のスキーマに影響を及ぼすことがない。拡張性・柔軟性が高い。
  - テナントを追加する場合、データベース全体を新しく構築するよりも、既存のデータベースとインフラを再利用するため、比較的容易に追加できる。

- デメリット
  - データベースに障害が発生した場合、全テナントに影響が及ぶ。
  - ノイジーネイバー問題
    - 特定のテナントがインフラリソースを大量に消費した場合、他のテナントのサービス利用に影響を及ぼす問題のこと。
  - クエリを書く際に、スキーマ名を明示的に記述する必要があるため、スキーマ名が変更された場合、該当するクエリを全て修正する必要が出てくる。

### すべてのテナントで同じスキーマを使う
- メリット
  - インフラ部分を共通化できるため、運用・メンテナンスにおけるコストを抑えることができる。また、リソースの利用効率もいい。
  - データモデルの変更が必要な場合、すべてのテナントが共通のスキーマを使用しているため、一括で変更が可能。変更容易性。
  - テナント間で共通の機能・データを共有しやすい。
  - テナントの追加が容易。
  - データ操作におけるアプリケーション側のロジックがシンプルになる。
    - テナント固有のデータはテナントIDなどを使用して区別するため、テナントごとにデータベース接続情報を切り替えたり、スキーマを指定したりする必要がない。

- デメリット
  - データベースに障害が発生した場合、全テナントに影響が及ぶ。
  - ノイジーネイバー問題。
  - テナントごとに固有属性の追加などのカスタマイズが難しい場合がある。
    - 共通情報のテーブルに対して、テナント固有属性のテーブルを作成し、共通情報と紐づけられるようにしてテナント固有情報を付与していくことが対策として考えられる。
  - 複数テナントのデータが混在しているため、データベースクエリの実装やテナントごとに適切なアクセス権限を設定するなどの点に注意する必要がある。

## RLS（Row-Level Security）
- RLSとは、データベースのレコード単位でアクセスを制御するセキュリティ機能のこと。
  - 「Aさんはこのデータを見ることができるけど、Bさんはこのデータを見ることができないよー」を行単位で実現。
- なぜ共有データベース共有スキーマのアーキテクチャとの組み合わせが有力なのか
  - そもそも一つのデータベース、一つのスキーマで複数テナントを管理する方がコスト面や変更容易性を考えると現実的な選択（かなりの数のテナントが利用するサービスとなるとなおさら）
  - 安全性の問題がある…。課題の例としてあった、自テナント以外のテナントの情報が操作できてしまうような問題が生じる可能性。
    - 上記の問題を起こさないようにするためには、アプリケーション側のデータアクセス実装箇所おいて、適切なWHERE句を忘れずに書く必要がある。
    - 開発者に頼ってしまう点や、コードレビューで防ぐにしてもサービスの規模が大きくなると見落としてしまう可能性も出てくる…。
  - RLSを使用することで、アプリケーション側に代わってデータベース側がデータアクセスに関するセキュリティを担保してくれるため、クエリにWHERE句が設定されていなくても、自テナントのデータのみ操作されるように制御できる。実装漏れなどの人為的ミスを防止することができる。
- 実装方法
  - テナント間でデータを区別する必要があるため、各テーブルにテナントIDカラムを設ける。
  - 各テーブルに対するRLSポリシーを作成する。
    - RLSポリシーとは、それを定義する式にマッチした行に対して、SELECT／INSERT／UPDATE／DELETEする権限を与えるもの。
    - テナントIDに基づいてデータのフィルタリングを行う条件を定義する。
  - テーブルに対して作成したポリシーを`ALTER`によって有効にする。

### 参考記事
[PostgreSQLのRow Level Securityを使ってマルチテナントデータを安全に扱う](https://times.hrbrain.co.jp/entry/postgresql-row-level-security)  
[CREATE POLICY](https://www.postgresql.jp/document/9.6/html/sql-createpolicy.html)  
[PostgreSQLのRowLevelSecurityでマルチテナントをやってみた](https://qiita.com/revenue-hack/items/db66ce9d7cc4fa347111)