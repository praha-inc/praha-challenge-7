# データベース設計のアンチパターンを学ぶ9

## 課題１
### どのような状況で「Check」「Enum」「Domain」「Trigger」使う/使わないべきか
- 「mailAddress」カラムに特定のドメインを使ったメールアドレスしか登録できない場合にCheck制約は？
  - つけない方がいい
    - Check制約をつける場合は対象のデータが不変なものであり、ON/OFFのような相互排他的な値が望ましい。
    - 今回のケースだと、特定のドメイン以外も登録を許容しようとなった場合に、DB側の制約を再定義する必要が出てきたり、逆にすでに登録されているドメインを今後登録できないようにしたい場合に、Check制約をつけることができない（既存の値の更新などをする必要がある）。

- ユーザーが退会した時、「User」テーブルから削除し「WithdrawUser」テーブルに同じ情報を挿入しなければならない場合、Triggerは使うべき？
  - 使わない方がいい
    - Triggerを実装することでレコード挿入などを自動で行うことができるが、アプリケーション側からはDB側でどんな処理が行われているかはわからない。そのため、新たに別モジュールでユーザーを退会させるロジックを作成した際に、「WithdrawUser」に退会ユーザーの情報を登録するという処理をアプリケーション側で実装されてしまう恐れもある。
    - アプリケーション実装者がシステムの調査をする際に、ソースから処理の全貌を把握することができない。それ故、Triggerが原因でパフォーマンスに問題があった場合にも気付きづらい。

- 「gender」カラムに「male」「female」「no response」のいずれの値しか入れてはいけない。Enumを使うべき？
  - 使わない方がいい
    - Enumにどんな値が設定されているのかはDB定義を見に行かないとわからず、「male」ではなく「男」にしたいというような使用変更があった場合、既存データの考慮も必要になるため不具合が生じる恐れがある。

- 「postCode」カラムには特定形式の文字列しか入れていはいけない。Domainを使うべき？
  - 使うべきではない
    - 例えば、当初は「1230123」という形式で保存していたが、「123-0123」という形式にしたいという要望があった場合、対応が大変。また、アプリケーション実装者が要望を受けてロジック側を修正したのに、Domainに気付けず結局登録できないということも起こりうる。

## 課題２
### アプリケーション側で制約を課すアプローチとDB側で制約を課すアプローチについて
- 基本的には、アプリケーション側でビジネスルールに沿って検証などを実装すべき。
  - 仕様の変更・追加要望はどうしても発生してくるため、柔軟に修正・追加対応しやすいのはアプリケーション側。DB側で設定される制約・TriggerなどはRDBMSに依存する部分もあったり、自由度が限られることもありどんな仕様の変更にも耐えれるかと言われると厳しい。
  - DB側で定義、制約を変更するとなると広い範囲に影響が及ぶこともあり得る。
  - DB側で制約をつける場合は、仕様の変更があった場合でも問題がない、もしくは変更が想定されないようなもの（不変で相互排他的な値）にすべき。

## 課題３
- ECサイト
  - 買い上げのあったお客様を「Guest」「NewCustommer」「MiddleCustomer」「LoyalCustommer」と、買い上げ金額、頻度などからランクづけする「Rank」カラムを用意しCheck制約で入力値を管理。
  - しばらくして、「NewCustommer」と「MiddleCustomer」の間に「LowerCustomer」を、「LoyalCustommer」の上に「VIP」を追加することになり、Check制約を再定義。
  - さらにしばらくすると、ランクを高い順からA,B,C,D,E,Fにしてほしいと要望があり、Check制約の再定義と既存のデータの更新を行なった…。