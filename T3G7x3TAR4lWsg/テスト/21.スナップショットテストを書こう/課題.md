# 課題１（質問）

> スナップショットテストとはなんでしょうか？説明してください

フロントエンドのレンダリング結果を保存し、次回のテスト実行の際に現在の状態と差異があった場合にテスト失敗とすることで、アプリケーションの変更によるフロントエンドへの意図しない影響やデグレーションを防ぐ目的がある。


> スナップショットテストを用いることで、どのような不具合が防止できるでしょうか？3つほど具体的な例を挙げてみてください

### 1. コンポーネント内の値やタグ、クラスなどの出力の変更に関わる変更の検知

例：スタイリングの都合で親コンポーネントのクラスを変更したことにより、そのクラスをPropsで受け継いで状態を出し分けていた子ボタンコンポーネントがあったが、想定していない値が入ったことで、描画が変わってしまっていた。それを検知できた。

### 2. ロケールの変更や日付のスタイルの変更の検知など出力フォーマットの差異の検知


例えばブログの投稿日のタイムスタンプをyyyy-mm-ddで表示させていたがyyyy.mm.ddに変更する事になった。いくつかの画面で修正を加えたが、一部の表示で本来変えるべきでなかった日付まで変えていることが分かった。


### 3. 出力ロジックの変更の検知

例③: 例えばSQLの集計に基づいた集計テーブルをフロントエンドで表示させており、その集計ロジックの部分を変更した。
その変更が正しく行われたか、スナップショットテストで確認することができた。


> スナップショットテストでは防止できない不具合もあります。3つほど具体的な例を挙げてください

### 1. 外部からのスタイリングによるレンダリングの変更はテストできない

例①：デザインの方向性が変わり、グローバルに設定されていたtheme.cssが変更された。ボタンの大きさが変わったことによって、一部の内容がはみ出てしまっていたが、コンポーネントごとのレンダリングには影響がなかったため、スナップショットテストで通過してしまっていた。

### 2. 静的なテストであり、特定の条件による動的な状態の場合テストできる訳ではない

例②：
アンケートフォームにおいて、ユーザーがある選択肢を選んだ時だけ、特定の追加の質問群が表示される仕様であった。
しかし、スナップショットテストではフォームの初期状態しか取れておらず、いつの間にかアプリケーションの変更に伴って選択肢が増えた事で、該当のValueが変化し、その選択肢を選んでも追加の質問群が表示されなくなっていた。リリース後、その追加質問の部分だけ回答が全然集まらないことで客先からの問い合わせで発覚し、クレームとなり、仕事の支払いでもめることになった。


### 3. クロスブラウザなどを正確にテストできる訳ではない

例③：「テーブルの見出しに影を付けたい」という要望があり、CSSの変更を行った。スナップショットテストは意図通り失敗し、変更したCSSも申し分ないように思われた。
しかしSafariのバグにより明らかにiPhoneユーザーだけ表示がおかしい、というクレームが起きてしまった。



# 課題２（実装）

> 先の課題で実装したreact チュートリアルのStorybookに、スナップショットテストを追加してください

こちらに実装しました。

https://github.com/sutefu23/storybook/pull/2

>ヒント：Storyshotを使うのが最も簡単です

ご存知の通り、これは大変な罠でした。

結局試行錯誤の末諦めてStoryshotは使わず、下記を参考にtesting-library/reactでrenderしたものをsnapshot保存する方法で対応しました。

https://lightbulbcat.hatenablog.com/entry/2019/08/08/040659

# 課題３（クイズ）

### 1. スナップショットテストとビジュアルリグレッションテストの違いは何でしょうか？

###  答え:
スナップショットテストにおいてはシリアライズされた値をテキストファイルに格納して比較します。
ビジュアルリグレッションテストのツールはwebページのスクリーンショットを取得して出力された画像をピクセル単位で比較します。
つまりその検出方法と目的が異なります。
スナップショットテストは、コンポーネントの構造やプロパティが予期せぬ形で変更されないかをテストします。
ビジュアルリグレッションテストは、UIが視覚的に予期せぬ形で変更されないかをテストします。

参考 https://jestjs.io/ja/docs/snapshot-testing

### 2. テストもなく、テスタブルでもない関数によって動いてるレガシーなシステムがあります。において、スナップショットを導入することで、単体テストのコストを下げる方法があります。どのような方法でしょうか。

### 答え：
ロガーを用意して、そのロガーを使ってアプリケーションのあらゆる場所でデバッグ出力をして、その出力をスナップショットテストする、というGolden Masterという手法がある。

何かの拍子でログ出力の順番が変わったり、出力の内容が変わった時にスナップショットテストで気づくことができる。

アプリケーションコードにはログ出力するコードを差し込むだけで、インターフェイスを全く変更する必要が無いので安全かつ簡単に導入が可能。

参考　https://www.mizdra.net/entry/2021/02/04/003728

### 3: スナップショットテストには、下記のうちどのような制約や限界がありますか？
- ①. ビジュアル（色、スタイル）の変更を検知できない
- ②. ユーザーインタラクション（クリックや入力）をシミュレートしてテストすることができない
- ③. 全てのブラウザでのレンダリングの違いを検知することができない
- ④. 上記の全て

### 答え：
④上記のすべて
スナップショットテストは、レンダリングされたものをシリアライズした、その時の静的な状態を比較するに過ぎないため、①～③を検知することはできない。

