## 課題1

> 「Check」「Enum」「Domain」「Trigger」などを使うべきか否か

「Check」「Enum」「Domain」に関しては
- SQLのバージョン次第でサポートされてないものがある。
- 「その制約がある」ということがＳＱＬを解析しないとわからない。
- 制約の変更があった場合の変更容易性が低く、過去のデータが制約に引っかかるようになった場合削除やテーブル変更の対応を迫られる

などのデメリットがある。

Triggerはログ的にデータを保存していくには向いているが、
- テーブルにロックがかかる為、Triggerを直接引っ張ってきて元データに復元する事ができない
- 大規模なデータ変換のクエリが走った際トランザクションが多くなる。
- テーブルの構造に変更があった場合適切にTrigerの対象テーブルもマイグレーションしなければ、データ更新時にエラーがでてしまい気づきにくい

トリガーは暗黙的に実行されるためこのように保守しにくいリスクがあるため注意が必要。


## 課題2(?)

> 上記のような制約をアプリケーション側で課すアプローチと、データベース側で制約を課すアプローチがあります。どちらをどのような時に採用するべきだと思いますか？

基本はアプリケーション側でドメインオブジェクトを使ってクラスでロジックに基づいた制約を表現すべきである。
よほど「今後絶対変わりようがなく、また絶対にデータに入っては致命的なもの」（例えば絶対ユーザーの所持金が0以下になってはいけない、など）以外はこのような制約をSQL側で作る意味は薄い。

## 課題3

> どんなサービスを開発している時に上記のようなアンチパターンに陥りそうでしょうか？最低でも1つは例を考えてみてください

- 当初「『gender』カラムには『male』『female』『no response』いずれかの値しか入れてはいけないという制約でEnumを作った」。またそれ以上将来変わりようがないと思っていたが、サービスがタイに進出することになり、タイでは18種類の性別があるため、Enumを見直す必要がでてきて、性別にかかわるデータは全てマイグレーションする必要が出てきた。

- 売上管理を作った際に、売上に関わるフィールドは絶対マイナスになってはいけない、と思い全てにCHECK制約で0以上であるようにして「堅牢なシステムが作れた」と満足していた。しかしそのうち「業務課だけ赤伝でマイナス計上をしないといけない。これでは業務ができない」とクレームがつき、全てのCHECK制約を外す必要が出てきた。しかしこれまでSQL側でCHECK制約を行っていたがために、アプリケーション側でちゃんとチェックをしておらず、本来0以下になってはいけないところまでバリデーションが漏れて0以下が入ってしまい、炎上案件となってしまった。