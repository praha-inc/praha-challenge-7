## 課題１

> 生徒を管理するテーブルで、「在学中」「卒業」「停学中」などのステータスが存在します
> MySQLやPostgreSQLでは上記のようにCheck制約を設けることで挿入できるデータを限定できます
> 上記の設計だとどのような問題が生じるか、説明してください


### 回答
Check制約は、今後恒久的に変わらないであろう値（例えばLeft,Rightとか）や、DBに入ってしまうとビジネス的に致命的なものなど（例えば絶対マイナスになってはいけない値など）、についてはSQL側で値を担保できる安心感もあるが、堅牢性の代償に柔軟性を無が無くなるデメリットも大きく、

- 要件が変わるたびにテーブルのマイグレーションが必要

- 過去は問題無かったデータがCheck制約において許されなくなった場合、テーブルの変更かデータの変更が必要になる

例えば今回の場合、例えば「復学」や「退学」などのステータスを加えたくなったときや、過去あった「停学中」が必要なくなった時など、マイグレーションやデータの入れ直しなどが必要になってくる。

またそれ以外に

- 一度設定した文字列を後で変更したくてもできなくなる。（例えば作った人がstadiingとタイポしてしまってるが治せない、など）

- MySQL8より前のバージョンではCHECK制約が無く、全てのDBで同じCHECK制約がサポートされているわけではない

- コードが側だけではなく、DBの制約まで確認しなければビジネスロジックを確認することができない

などのデメリットもある。

## 課題２

> どのようにテーブル設計を見直せばこの問題は解決できるでしょうか？新しいスキーマを描いてみてください

ステータスを別テーブルとして切り出すことで上記問題を回避し、柔軟な設計とした。

```
TABLE Student {
  id varchar [PK]
  name varchar
  status_id varchar [ref:- Status.id]
}

TABLE Status{
  id varchar[PK]
  name varchar [note:"在籍中,退学,停学・・・"]
}
```

[UML図](課題2UML.png)

## 課題3

> どんなサービスを開発している時に上記のようなアンチパターンに陥りそうでしょうか？最低でも1つは例を考えてみてください

- 飲食店のサービスでサイズとして「SML」をCheck制約を使って用意していたが、「女性客向けにXSを追加したい」と言われてチェック制約を作りなおした。
しかしそのうち「昨今の健康志向でLサイズを廃止する。従業員が旧システムのノリで間違っていれないようにLは絶対入らないようにしてほしい」と言われて、これまでの慣例でCHECK制約で実現しようとすると、過去のデータのLサイズまで削除、もしくはテーブルを作りなおす必要が出てきてしまい、アプリケーション側で今度はLの時にエラーを出すようにした。結果アプリケーション側とSQL側で制約が書かれる場所が変わってしまい、アプリケーションが肥大化するうちにバグを生み出すようになった。


- ロールプレイングゲームを作っていて、各ユーザーの生死判定として"alive"か"dead"というcheck制約を作っていた。生きるか死ぬかなんて恒久的に変わらないだろう、と思っていた。この時までは。。
しかし、そのうちリリース後の追加コンテンツとして「裏世界を作る」とプロデューサーが言いはじめた。プロデューサーは「裏世界では全員ゾンビの世界だ！生きても死んでもない特殊な状態を作ってくれ」と言われた。そもそも生も死もないため、同じテーブルの制約に追加することも出来ず、別テーブルで「"zonbie"」という状態を管理するテーブルを作った。
そのうち「表世界に行くとHPの最大値が変わってしまう」「キャラクターが変わってしまう」などのバグ報告が各地から寄せられ、調査すると表世界と裏世界で使うテーブルが異なることがアプリケーションの複雑さやバグの温床となっていることが分かった。
さらに調子の良いプロデューサーが「裏世界でも『聖水:というアイテムを取ったら生き返って"alive"ってなるようにしよう」とか言い始めて、テーブルがマジ無茶苦茶になってきた。