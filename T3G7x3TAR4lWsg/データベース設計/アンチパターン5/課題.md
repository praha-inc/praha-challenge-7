# 課題１

>Salesforceのようなサービスを想像してみてください。以下のようなテーブルで新規顧客の営業進捗を管理しているとします

- 「進捗を管理」という点においては柔軟性が無く不十分

  例えば一度「成約をしたがキャンセルした」「面談せずに成約が決まった」など、ここで想定されている単一なフロー以外の例外的な事象が発生した場合管理できない。

- フローが追加や変更されるたびにフィールドを追加するしかない

  例えば「面談の2回目も管理するようにしたい」「成約後のアフターフォローをしたかどうかを管理したい」など業務に追加変更された場合や、「今後オンラインで対応するため電話のアポは必要なくなった」など業務フローの変更に弱い。

- フィールドの正規化もやりにくいため拡張性が低い
  例えば備考や担当者など、付加的な情報を追加したい、となった時に別テーブルで管理することもやりにくく拡張性が低い

## 課題２

> どのようにテーブル設計を見直せばこの問題は解決できるでしょうか？新しいスキーマを描いてみてください


業務フロー内容をProcessCategoryとして切り出し、進捗自体はCustomerProcessとして管理。
また上記の業務フローの変更や廃止に対応するためにorderやis_activeを入れてアプリケーション側で入力しやすいようにしました。（こういうのは大体どうせ後から「並び替えられるようにして欲しい」とか依頼されるので。。）

```
TABLE Customer {
  id varchar [PK]
  customer_name varchar
}

TABLE CustomerProcess{
  id varchar [PK]
  customer_id varchar [ref:< Customer.id]
  process_category varchar [ref: < ProcessCategory.id]
  datetime timestamp [note:"日時"]
  note text
}

TABLE ProcessCategory{
  id varchar[PK]
  process_name varchar [note: "電話、面談、成約・・など"]
  order uint [note: "並べ替え"] /*業務でフローが変わったり、新規で追加された内容をフローの中に入れたい時など*/
  is_active bool [note: "表示非表示"]/*業務でフローが廃止された時など*/
}
```

[UML図](課題2UML.png)

## 課題3

> どんなサービスを開発している時に上記のようなアンチパターンに陥りそうでしょうか？最低でも1つは例を考えてみてください

ジムの顧客管理サービスで顧客の状態が「入会中」か「休会」そして「退会」かどうかという状態しかなく、日付として「それぞれいつ入会、退会したか」、という事しか管理する必要がなかった。
しかしそのうち、「復会」という人が現れてこれまでフィールドで管理していたため「復会」と「復会日」というフィールドを追加した。
さらに今度はフランチャイズで多店舗展開するようになり、エニタイムフィットネスのように他店舗の利用回数が多い場合はその店舗に所属が移る事り、「入会日」だけではなく「店舗入会日」も必要になった。「店舗入会日がある人は契約金額を変更して欲しい」とか、さらに今度は「また本部店舗に戻った人も管理したい」などとなって、クエリは複雑になり、要件の複雑化によるバグが多く収拾がつかなくなった。