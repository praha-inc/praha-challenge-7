## 課題1
外部キー制約の効果と副作用
### 1. 例えば「Book」と「Author」テーブルなど、親子関係にあるデータに外部キー制約を一切定義しないとどのような問題が起き得るでしょうか？

- **参照整合性を保てない**
    - Authorテーブルからレコードを削除したときに、その著者に関連するBookテーブルのレコードが孤立してしまう可能性がある。
    - Authorテーブルの特定の値を更新した場合、それに依存しているBookテーブルの該当する値が更新されない可能性がある。

### 2. 逆に外部キー制約を定義することでどのような問題が起き得るでしょうか？

- **on delete cascade**制約で意図せず大量のchildレコードを削除する恐れがある。
- 外部キー制約を不適切に使用することで、デッドロックが発生する可能性がある。

## 課題2
### 外部キー制約を作成する際には「ON DELETE CASCADE」など参照アクションを定義できます。MySQLで選択可能な参照アクションと、それぞれの参照アクションを選択すべきケースを挙げてください

1. `CASCADE` :  親テーブルの行が削除または更新されると、その変更が子テーブルにも伝播する。
    - [選択すべきケース] 親テーブルの変更が子テーブルに直接影響を及ぼすべき場合。
1. `SET NULL` :  親テーブルの行が削除または更新されると、その行に関連する子テーブルの外部キーがNULLに設定される。
    - [選択すべきケース] 親テーブルの行がなくなっても子テーブルの行が独立して存在できるべき場合。
1. `SET DEFAULT` :  親テーブルの行が削除または更新されると、その行に関連する子テーブルの外部キーがその列のデフォルト値に設定される。
    - [選択すべきケース] 親テーブルの行がなくなった場合に、子テーブルの行が特定のデフォルト値に戻るべき場合。
1. `NO ACTION` : 親テーブルの行が削除または更新されると、外部キー制約がチェックされ、その行に関連する子テーブルの行が存在する場合、その操作は拒否される。
    - [選択すべきケース]  親テーブルの行が子テーブルの行に依存している場合、つまり親テーブルの行が削除または更新されるとデータの整合性が損なわれる場合。
1. `RESTRICT` : `NO ACTION`と同じ。
    - [選択すべきケース] `NO ACTION`と同じ。

### いくつかユースケース
- 従業員管理サービス
    - 部署がなくなっても従業員が消えるわけではない。つまり、挙動が事実に反してしまう。
    - 選択すべき外部キー制約 : `SET NULL` または `NO ACTION` / `RESTRICT`
- プロジェクトマネジメントツール
    - Assigneeテーブルのレコードが削除された際に、Issueテーブルのassignee_idカラムがNULLに設定されてしまう。この挙動は、要件に反している。
    - 選択すべき外部キー制約 : `NO ACTION` / `RESTRICT`

### ORMの参照アクションにどのようなデフォルト値を設定しているか調べてみる
- Active Record (Ruby)
    - Active Recordでは、`ON DELETE CASCADE`に相当する設定`dependency: delete`しかない。
    - デフォルトは、参照アクションなし。
    - 考察 : 単純にActive Recordは、DB管理ツールの機能の細かいところまではサポートできていないのかも。もしくは、参照アクションを容易に設定できることでの事故を避けるためにあえてサポートしていないのかも。
    - 参考　[Railsで外部キー制約の参照制約の書き方](https://qiita.com/na-777/items/cf17f8c79cc76af2898d)
- Eloquent ORM (PHP)
    - 参照アクションはサポートしていない。
    - Eloquent eventsを使用することで、参照アクションを再現することはできる。
    - 考察 : Eloquentは、Active Recordより更に明確にサポートしていない。参照アクションを避けているのかも。
    - 参考　[Automatically deleting related rows in Laravel (Eloquent ORM)](https://stackoverflow.com/questions/14174070/automatically-deleting-related-rows-in-laravel-eloquent-orm)

### MySQLとPostgreSQLではrestrictとno actionの扱いに少し違いがあります。それはどのような違いでしょうか？
- MySQL
    - MySQLでは、`NO ACTION`と`RESTRICT`は実質的に同じ。
    - 両方とも子テーブルにおける外部キー制約違反を直ちにチェックする。
- PostgreSQL
    - NO ACTIONは制約違反がトランザクションの終わりまで遅延される。つまり、トランザクション内で他の操作が制約違反を解消する場合、その制約違反は発生しない。
    - RESTRICTは即座に制約違反をチェックする。

## 課題3
1. MySQLで外部キー制約が違反されたときのデフォルトの挙動は何ですか？
    - 正解: `NO ACTION`
1. `ON DELETE SET NULL`を使用した場合、なぜ参照される列がNULLを許可するように設定する必要があるのですか？
    - 正解: NULLを許可にする必要がある。親テーブルの行が削除されたときに子テーブルの参照値をNULLに設定するため。
1. 外部キー制約が一時的に無効化されるコマンド`SET FOREIGN_KEY_CHECKS = 0;` は実際に存在するでしょうか？
    - 実在する。テーブルの内容を一括削除したり、大量のデータをインポートする際など、外部キー制約が一時的に邪魔になる場合に便利。
### 参考
- [外部キー制約が一切ないと何に困るのか？](https://zenn.dev/praha/articles/2667cbb1ab7233?redirected=1)
- [外部キー制約でデッドロックに引っかかった話](https://zenn.dev/nasu/articles/40ba32d259dc47)