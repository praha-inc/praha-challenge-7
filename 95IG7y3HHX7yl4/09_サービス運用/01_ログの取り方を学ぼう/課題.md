# 課題１（質問）
## ログレベルとは何でしょうか？
ログレベルとは、ログメッセージの重要度や緊急度を示す指標

### どのようなレベルがあるのでしょうか？
(重大度の降順)

| 種類      | 意味                                                                 |
|-----------|----------------------------------------------------------------------|
| EMERGENCY | システムが使用不可能であり、即時の注意が必要であることを示します。   |
| ALERT     | 重大な問題を解決するために即時の行動が必要であることを示します。     |
| CRITICAL  | システム障害を防ぐために介入が必要な重大な状態を示します。           |
| ERROR     | ある操作に支障をきたすエラー状態を示しますが、重大な状況ほどではありません。|
| WARNING   | 将来的にエラーや予期しない動作を引き起こす可能性のある問題を示します。|
| NOTICE    | 監視が必要な正常だが重要な状態を示します。                           |
| INFO      | システムの通常の動作を記録するメッセージを含みます。                 |
| DEBUG     | システムの詳細情報をデバッグ目的で記録するためのものです。           |

ちょっと細かすぎるかも
EMERGENCY、ALERT、CRITICALとかNOTICE、INFOとかの使い分けが難しい気がする。

こっちのシンプルな方がわかりやすく個人的には運用しやすい印象。
多くのLoggingフレームワークでも、こっちを採用しているっぽい。

| 種類   | 重要度                                                                 |
|--------|----------------------------------------------------------------------|
| Fatal  | 主要なビジネス機能が一つ以上動作しておらず、システム全体がビジネス機能を満たしていない状態を示します。 |
| Error  | 一つ以上の機能が動作しておらず、一部の機能が正しく動作するのを妨げている状態を示します。 |
| Warn   | アプリケーション内で予期しない動作が発生しましたが、作業は継続しており、主要なビジネス機能は期待通りに動作しています。 |
| Info   | イベントが発生したことを示し、そのイベントは純粋に情報提供のためのものであり、通常の操作中に無視することができます。 |
| Debug  | ソフトウェアのデバッグ中に有用とされるイベントのためのログレベルで、より詳細な情報が必要な場合に使用されます。 |
| Trace  | コードのステップバイステップの実行を示すイベントのログレベルで、標準操作中には無視できますが、拡張デバッグセッション中に役立つことがあります。 |

### ログレベルを指定しておくとどのようなメリットがあるのでしょうか？
- ログのレベルごとに対応方針をあらかじめ決めておくことで、都度悩む必要がなくなる。
- 情報のフィルタリングが容易になる

## アプリケーションログにはどのような情報を含めるべきでしょうか？
| 項目       | 内容                           | 備考                                           |
|------------|--------------------------------|------------------------------------------------|
| 時間       | ログを記録した時間             | 年月日時分秒ミリ秒。最低でもミリ秒単位で出力する必要がある |
| イベントID | イベントのID                   | 一連のイベントをトレースするために必要          |
| ログレベル | ログのレベル                   | INFO、ERRORなど                                |
| リクエスト対象 | どこに対してのリクエストか   | URLなど                                        |
| ユーザー情報 | リクエストしたユーザーの情報   | ユーザーIDやIPアドレスなど                      |
| 処理対象   | 何に対する処理を行ったか       | 処理を行ったリソースのIDなど                    |
| 処理内容   | どのような処理を行ったか       | DELETE、PUT、GETなど                            |
| 処理結果   | 処理を行った結果どうなったか   | 成功、失敗、処理件数など                        |
| メッセージ | その他、出力したい内容         | ログレベルがエラー以上の時にメッセージがあると望ましい |
| 環境情報   | ログが生成された環境           | 開発、テスト、本番など                          |

[今さら聞けないログの基本と設計指針:ログのフォーマット](https://qiita.com/tadashiro_ninomiya/items/19c774898c68add6185e#%E3%83%AD%E3%82%B0%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88)

### 逆にログに含めない方が良い情報があれば、教えてください
個人情報は法的な制限で禁止されている場合もある。
- IPアドレス
- ユーザ名
- パスワード
- メールアドレス
- クレジットカード番号など

## どのようなタイミングでログを出力すると良いでしょうか？（例えば「正常系の処理が終了したとき」「例外が生じたとき」など）ログレベルと併せて考えてみましょう
- Fatal
  - 重要な構成情報が欠落しており、フォールバックのデフォルトがない場合。
  - コアアプリケーションの操作に必要な重要な外部依存関係やサービス（データベースなど）が失われた場合。
  - サーバーのディスク容量やメモリが不足し、アプリケーションが停止したり応答しなくなった場合。
  - セキュリティ侵害や機密データへの不正アクセスが検出された場合。

- Error
  - 外部APIやサービスの障害がアプリケーションの機能に影響を与える場合(自動復旧の試行が失敗した後)。
  - ネットワーク通信エラー、例えば接続タイムアウトやDNS解決の失敗。
  - システム内でリソースの作成または更新に失敗した場合。
  - 予期しないエラー、例えばJSONオブジェクトのデコードに失敗した場合。

- Warn
  - リソース消費が事前に定義されたしきい値(メモリ、CPU、帯域幅など)に近づいている場合。
  - アプリケーションが重大な影響を受けずに回復できるエラー。
  - 推奨されるプラクティスに沿っていない古い設定。
  - セキュリティ脅威の可能性を示す過剰な数のログイン失敗試行。
  - 外部APIの応答時間が許容範囲を超えている場合。

- Info
  - 操作の状態が「PENDING」から「IN PROGRESS」に移行するなどの状態変化。
  - スケジュールされたジョブやタスクの正常な完了。
  - サービスやアプリケーションコンポーネントの開始または停止。
  - アプリケーション内の重要なマイルストーンや重要なイベントの記録。
  - 長時間実行されるプロセスやタスクの進捗状況の更新。
  - システムのヘルスチェックやステータスレポートに関する情報。

- Debug
  - データベースクエリは、パフォーマンスのボトルネックやデータの取得や操作に関連する問題を特定するのに役立ちます。
  - 外部API呼び出しの詳細とその応答。
  - 設定値は、誤設定や不一致の設定をトラブルシューティングするのに役立ちます。
  - 特定の操作やメソッド実行の期間などのタイミング情報。

- Trace
  - 関数やメソッドに入るときや出るときに、関連するパラメータや戻り値と共にログを出力する。
  - ループ内のイテレーションの詳細、例えば現在のインデックスや処理中の値をログに記録する。
  - 特定の出力や中間結果を生成する計算や操作をログに記録する。

[Log Levels Explained and How to Use Them](https://betterstack.com/community/guides/logging/log-levels-explained/)


## ログを全て人力で検査するのは大変なので、スクリプトなどで集計しやすいように、パースしやすいメッセージを作ることも大切だと言われます。どのようなログメッセージならパースしやすくなるでしょうか？
### ログのパースとは
logをtextのまま読んで解析するのは大変。
たから、ログメッセージは一貫したフォーマットで記録しパースすることで、解析しやすくする。

パースしやすくする為に、一貫したフォーマットで記録することが重要。
- タイムスタンプ、ログレベル、メッセージ内容の順番を統一する
- JSONやXMLのような構造化データ形式を使用する
- フィールド間に明確な区切り文字（例えば、カンマやタブ）を使用する
- 時間情報のパースが容易にするために、ISO 8601形式のような標準的なタイムスタンプ形式を使用する

## 構造化ログが大切だと言われます。構造化されていない場合、どんな問題が起きるでしょうか？
ヒント: AWSのCloudWatch Logsのようなログ収集用のツールを用いるケースで考えてみましょう
AWSのCloudWatch Logsのようなツールを使用する場合、ログが一貫したフォーマットでないと、フィルタリングや検索が困難になる。

## 以下のログの種類を説明してください
### アクセスログ
PCやサーバへの接続履歴のことで、特にWebサーバへの通信記録を指す場合が多いです。いつ、誰が、どこから接続したのかを確認できます。

### アプリケーションログ
アプリケーションログは、システム上で動作している様々なアプリケーションの動作やアプリケーション上でのユーザーの操作などを記録するログ。

### エラーログ
エラーが発生したときに記録されるログです。エラーの内容やエラーの発生日時や状況などが記録されます。エラーログを参照すれば、発生した障害がなぜ起きたのか、原因を比較的簡単に特定できるようになります。

### （フロントエンドの）ユーザーログ
ユーザーの操作（クリック、スクロール、フォーム入力など）、エラーメッセージ、パフォーマンスデータ、ユーザーのセッション情報などを含む、クライアントサイド（ユーザーのブラウザ側）で発生するイベントやアクションを記録するためのログ

### データベースのクエリログ
クライアントからの MySQL Server への接続・接続解除の情報、およびクライアントから実行された全ての SQL クエリを出力してくれるログ。

## ログローテーションとは何でしょうか？
ログローテーションとは、ログファイルが一定のファイルサイズに達したり、一定の期間が経過したらファイル名を変更しログファイルを切り分け、古くなったログファイルは消去する作業を言いう。

### どのようなメリット/デメリットがあるのでしょう？
メリット
- ログが肥大化し、ディスク容量やメモリの容量を圧迫するのを避ける
デメリット
- 古いログが消えてしまう。必要な過去のデータが失われる可能性があり、長期的なトレンド分析や問題の追跡が困難になる。

### 最近では使われる頻度が減りつつありますが、どのような背景があるのでしょうか？
- ディスク容量の増加とコストの低下。
- クラウドストレージを利用するようになり、ログデータをクラウドに保存することで、オンプレミスのストレージ容量の制約を気にする必要がなくなった。

## 最近ではサービスが稼働するインスタンスにログファイルを保存するのは避けた方が良いプラクティスとして言及されることもあります。それは何故でしょうか？
- インスタンスを削除するとログが失われてしまう。
- インスタンスがクラッシュしたり、停止したらログファイルにアクセスできなくなる可能性がある。
- 複数のインスタンスがある場合、それぞれのインスタンスに保存されたログを集約して管理するのは手間がかかる。
- 複数インスタンスにログが分散していると、アクセス制御が複雑で難しくなる。

### food for thought 1: 作成されたログファイルの閲覧権限を細かく管理したい時にはどうすれば良いのでしょう？例えばUserに関するログはManager以上の権限を持っていなければ閲覧できないとか。逆に例えばマネージャーが降格してUserに関するログを閲覧不可にする必要が生じた時、誰がどのような手順で管理すれば良いのでしょう？
- ログを集約して管理するための中央ログ管理システムを導入する。(例: AWS CloudWatch Logs)
- AWS CloudWatch Logsの場合は、ユーザーのロール割り当てで、ログへのアクセス権限を管理できる。

### food for thought 2: 特定のログを誰が閲覧したか、または誰が編集したか、どのように確認すれば良いのでしょう？
AWS CloudTrailを使用して、CloudWatch LogsやアーカイブのLogを保持しているS3バケットへのAPIコールを記録することで、誰がLogに対してどのようなAPIコールを行ったかを確認できるようになる。

### food for thought 3: 仮に複数のインスタンス（10個ぐらい）でサービスが運用されていて、リクエストを処理する途中で複数のインスタンスにログが分散したとします。このようなログをどうやって集約すれば良いのでしょう？
中央集約型のログ管理システム(CloudWatch Logsなど)を使用して、ログを一箇所に集約できる。

具体的には、各インスタンスにCloudWatch Logsエージェントをインストールし、インスタンス上のログファイルを監視し、CloudWatch Logsに送信することで集約する。

### food for thought 4: システムのストレージ容量をログファイルが食い尽くしてしまうことはないのでしょうか？
CloudWatch Logsで集約してログを管理する場合、古いログをS3などにアーカイブして保存できるので、心配ない。

## ログを取得する仕組みには大きく分けて「プル型」と「プッシュ型」がありますが、それぞれにどのようなメリットや使い所があるのでしょうか？
### プル型
監視サーバー側で監視対象ホストについて設定をし、監視サーバーから監視ホストにデータを取得しにいく。

メリット
- 監視対象一覧を知っているため、データを取得出来なかった時に異常に気づくことができる
- 監視サーバの負荷が高まった際に柔軟な対応がとりやすい

デメリット
- 監視対象ホストごとに設定が必要なため手間がかかる
- AutoScaling 等で監視対象の数が変わった場合に、監視対象リストをアップデートする必要がある
- 監視サーバーが監視対象にアクセスするため、監視対象のサーバーのポートを開けることが必要で、セキュリティリスクとなる可能性がある。


### プッシュ型
監視対象ホストにエージェントをインストールする。ホストにインストールされたエージェントが監視サーバーにデータを送信する形。

メリット
- 監視対象ホストにエージェントを導入するだけなので容易
- 監視対象が外からアクセスを受けるための設定が不要


デメリット
- 監視対象ホスト側での調製になるため、対象が増えると管理コストが高い
- 監視対象が増えた時に監視サーバに負荷が集中しがち

[監視ツールはPull型かPush型か](https://scrapbox.io/gosyujin/%E7%9B%A3%E8%A6%96%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AFPull%E5%9E%8B%E3%81%8BPush%E5%9E%8B%E3%81%8B)
[モニタリングシステムにおけるPull型とPush型のアプローチの違い](https://bmf-tech.com/posts/%E3%83%A2%E3%83%8B%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8BPull%E5%9E%8B%E3%81%A8Push%E5%9E%8B%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AD%E3%83%BC%E3%83%81%E3%81%AE%E9%81%95%E3%81%84#1-Pull%E5%9E%8B)

# 課題２（質問）
## 関数を実行中に例外が生じた時、関数に渡された引数をログするように実装しました。以下のような具合です
https://gist.github.com/Dowanna/5fb9e0efecde1c3f942133044c910cd8


## この実装にはどのようなセキュリティ上の問題がありそうでしょうか？
- 機密情報の漏洩: inputのオブジェクトをそのままlogで表示しているので、ユーザーの個人情報、認証情報など個人情報が含まれて、情報漏洩するリスクが高まる
- エラーメッセージの詳細化: objectをそのままlog出力することで、システムの内部構造が悪意のあるユーザーに知られて攻撃の手段にされるリスクが有る。
- ログインジェクション: `input` の内容がそのままログに記録されるため、攻撃者が特殊な文字列でログの構造を変えることができる。

[IDS03-J. ユーザ入力を無害化せずにログに保存しない](https://www.jpcert.or.jp/java-rules/ids03-j.html)

### food for thought 1：仮に秘匿情報が引数に含まれていたら・・・？
- そのまま出力されて情報漏洩するリスクが有る。

対策
- 個人情報を除去もしくはマスキングしてloggingする

### food for thought 2：仮にlog4j問題のように、攻撃を目的とした値が引数に含まれていたら・・・？
#### log4j問題
**Log4Shell**は、Log4j 2.xバージョン（特に2.0から2.14.1）に存在する**リモートコード実行（RCE: Remote Code Execution）**の脆弱性。
この脆弱性を悪用することで、攻撃者は対象システム上で任意のコードを実行でき、システムの完全な制御を奪取する可能性がある。

ログインジェクションのリスクが有る。
