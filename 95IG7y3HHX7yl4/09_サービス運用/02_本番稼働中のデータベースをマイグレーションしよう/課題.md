# 課題１（質問）
> データベースのスキーマを変更する際、一度のマイグレーションで全てのDDL文を実行することも可能ですが、文字通りぶっつけ本番で本番環境のDBを更新するのは怖いものです。
> またマイグレーションが完了するまでアプリケーションのダウンタイムが発生してしまうでしょう。特にデータが多くなるほど、スキーマ構造を変更しつつ、古いスキーマデータを新しいスキーマデータに変換するには長い時間がかかる可能性があります。

## 段階的にマイグレーションを実施する手法「expand and contract pattern」について、どのような手法なのか説明してみてください。
データベースのリファクタリングをするときに移行フェーズを設けることで、タイミング問題を回避する。
移行開始時と移行終了時の2つのタイミングをもち、移行中は古い状態と新しい状態の両方を維持します。それによって、移行状態では後方互換性を維持でき、他のシステムが変更に追いつくための十分な時間を与えます。

<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/syobochim/20200518/20200518224748.png">
[スキーマの変更をデプロイする方法](https://syobochim.hatenablog.com/entry/2020/05/20/084736)

## 開発環境でマイグレーションを実施した時は問題なかったのに、本番環境で実施したら失敗することが時々あります。
> 特に既存テーブルのカラムにNOT NULL制約を追加する時によく起きるのですが、何故でしょうか？
開発環境は通常データが少ないため、問題を見過ごしがち。

> この失敗を避けるためには、どのような対策が有効でしょうか？
- マイグレーションの2段階実行: 
  1. カラムを追加し、既存のNULLデータを適切な値で更新
  2. NOT NULL制約を追加
- デフォルト値の設定: default valueを新規追加のnon nullカラムに設定してあげる

## マイグレーション実行後に切り戻しを行う必要が出てくるかもしれません。マイグレーションの内容がDROP TABLEやDROP COLUMNである場合、データも消失してしまうため切り戻しが困難です。どのように切り戻しを行えばよいでしょうか？
1. データベースのバックアップと復元
  - 事前に取っておいたバックアップを使用して、基の状態を復元する。
2. 2段階マイグレーション 
  1. 即時削除ではなく、まず名前変更（例：users→users_old）を行う
  2. 新システムが問題なく動作することを確認した後、後続のマイグレーションで実際に削除する
3. ブルーグリーンデプロイメント
  1. 本番環境と同一の環境を用意し、そちらで先にマイグレーションを適用
  2. 問題がなければ本番環境を切り替える

# 課題２（実装）
> マイグレーションに限らず本番環境で何らかの作業を行う際は作業手順書を作成しておくことが多いでしょう。 自分以外の開発者でも実行できるように丁寧に手順を書き出すのみならず、事前に想定し得る問題を列挙して、いざ問題が発生したときの対応手順を書き出しておくと安心です。何か不具合が起きて、怒鳴られたり対応を急かされながら対応策を考えると余計にミスをしてしまうので...。
> 特大課題でモデリングしたプラハチャレンジのアプリケーションに仕様変更があり、ユーザが複数のチームに所属できるようになりました。この作りに対応するためにはデータベースのスキーマを変更する必要がありそうです。
ユーザーが複数チームに所属するってよくわからない、、
複数ペアに参加できるようになら意味がわかるので、こちらの課題はそう読み替えて実施します。

## マイグレーションの作業手順書を作成してください。
[マイグレーション作業手順書](./マイグレーション作業手順書.md)

## 上記以外に、どのような情報を手順書に残しておくと良いでしょうか?
- テスト計画
- タイムライン