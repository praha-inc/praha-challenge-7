# 課題1（質問）
> 以下の単語を使ってCORSの仕組みを説明してください
> preflight request
> simple request
> access-control-allow-origin

## CORSの概要
CORSは、Cross-Origin Resource Sharingの略。

[同一オリジンポリシー(SOP)](https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy)を回避して、異なるオリジンからアクセスを許可する仕組み。

オリジン: URL内の「スキーム＋FQDN(ホスト+ドメイン)＋ポート番号」

<img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1220815%2F7de34067-3ae3-36b0-8004-ad37ab5db589.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=5d02868fb685f7110e1f455e112ccb6c" >

[オリジン間リソース共有 (CORS)とは](https://qiita.com/Hirohana/items/9b5501c561954ad32be7)

## 実装
CORSの具体的な実装としては、異なるオリジンからリクエストを受けるサーバー側で、HTTPヘッダーの1つであるAccess-Control-Allow-Originをレスポンスに設定する。

```
// 特定のサイトを許可する
Access-Control-Allow-Origin: https://trusted-one.co.jp
// 全てのサイトを許可する(危険なのでプロダクトでは基本的には使わない)
Access-Control-Allow-Origin: *
```

## Simple Request と Preflight Request について
CORS ではリクエストの種類が Simple Request と Preflight Request の２種類に分けられています。違いはOPTIONメソッドリクエストを送るか送らないか。
Simple Requestは送らず、Preflight Requestは送る。

### Simple Request
Simple Requestは送らないリクエスト。

単純リクエスト (Simple Request) と言われているのは以下のメソッド。
- GET
- HEAD
- POST

サーバー側の実装イメージ
```js
const express = require('express');
const app = express();

// GETリクエストの処理
app.get('/simple-request', (req, res) => {
    res.header('Access-Control-Allow-Origin', 'https://trusted-one.co.jp');
    res.json({ message: 'GET request successful' });
});

// HEADリクエストの処理
app.head('/simple-request', (req, res) => {
    res.header('Access-Control-Allow-Origin', 'https://trusted-one.co.jp');
    res.sendStatus(200);
});

// POSTリクエストの処理
app.post('/simple-request', (req, res) => {
    res.header('Access-Control-Allow-Origin', 'https://trusted-one.co.jp');
    res.json({ message: 'POST request successful' });
});

app.listen(3000, () => {
    console.log('Server is running on port 3000');
});
```

より詳しくは、[オリジン間リソース共有 (CORS)](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E5%8D%98%E7%B4%94%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88)

### Preflight Request
Simple Requestは送るリクエスト。

プリフライトリクエスト (Preflight Request) と言われているのは以下のメソッド。

- PUT
- DELETE
- CONNECT
- OPTIONS
- TRACE
- PATCH

プリフライトリクエストのレスポンスとして、アクセスを許可するメソッドをレスポンスヘッダーに含める必要があります。

```
Access-Control-Allow-Methods: PUT, DELETE, PATCH
```

サーバー側の実装イメージ
```js
// app.js
const express = require('express');
const app = express();

app.options('/your-endpoint', (req, res) => {
    res.header('Access-Control-Allow-Origin', 'https://trusted-one.co.jp');
    res.header('Access-Control-Allow-Methods', 'PUT, DELETE, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type');
    res.sendStatus(204);
});

// 他のエンドポイントの実装
// app.put('/your-endpoint', ...);
// app.delete('/your-endpoint', ...);
// app.patch('/your-endpoint', ...);

app.listen(3000, () => {
    console.log('Server is running on port 3000');
});
```

### 参考
[なんとなく CORS がわかる...はもう終わりにする。](https://qiita.com/att55/items/2154a8aad8bf1409db2b)
[オリジン間リソース共有 (CORS)とは](https://qiita.com/Hirohana/items/9b5501c561954ad32be7)
[オリジン間リソース共有 (CORS)](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E5%8D%98%E7%B4%94%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88)



> Access-Control-Allow-Origin: *
> この設定が問題となるケースを1つ挙げて、なぜ設定するべきではないのか、説明してください

## この設定が問題となるケース
個人情報を含む可能性のあるサーバーに対して、Access-Control-Allow-Originをワイルドカード（*）に設定するケース。

## なぜ設定するべきではないのか
`Access-Control-Allow-Origin: * `に設定すると全世界に対して公開する API のようなコンテンツになり、セキュリティリスクが高まる。
なので、「Access-Control-Allow-Origin」を設定する場合は、意図した Web サイトのオリジンだけを設定するようにしましょう。

[Mastering Access Control Allow Origin: Your Guide to Secure Cross-Domain Requests](https://www.moesif.com/blog/technical/api-development/Mastering-Access-Control-Allow-Origin-Your-Guide-to-Secure-Cross-Domain-Requests/)
[Access-Control-Allow-Origin に設定する値として"マシ"なのはどちらか](https://securesky-plus.com/engineerblog/1821/)


> preflight requestが送信されない「シンプルなリクエスト」に該当するための条件を説明してください

- メソッドのうちのいずれかであること
  - GET
  - HEAD
  - POST
- 手動で設定できるヘッダーは、以下のヘッダーだけ
  - Accept
  - Accept-Language
  - Content-Language
  - Content-Type （但し、下記の追加の要件に注意してください）
  - Range （単純範囲ヘッダー値、例えば bytes=256- や bytes=127-255 の場合）
- Content-Type ヘッダーで指定できるメディア種別に許されるタイプ/サブタイプの組み合わせは、以下のもののみ
  - application/x-www-form-urlencoded
  - multipart/form-data
  - text/plain
- XMLHttpRequest オブジェクトを使用してリクエストを行う場合は、 XMLHttpRequest.upload プロパティから返されるオブジェクトにイベントリスナーが登録されていないこと。
- リクエストに ReadableStream オブジェクトが使用されていないこと。

↑ ほぼ、[オリジン間リソース共有 (CORS)](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E5%8D%98%E7%B4%94%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88)のコピーです(^_^;)

> シンプルなリクエストの場合はpreflightリクエストが送信されず、そのままリクエストがサーバに到達します。サーバからのレスポンスのAccess-Control-Allow-Originヘッダーに、リクエスト送信元のオリジンが含まれない場合、ブラウザはどのような挙動を取るでしょうか？

ブラウザーは同一オリジンポリシー(SOP)によって、レスポンスをブロックする。
具体的には、ブラウザはレスポンスをJavaScriptからアクセスできないようにし、エラーメッセージをコンソールに表示する。


> HTMLのaタグを辿って異なるオリジンに移動する際は、特にCORS制約は発生しません。なぜでしょうか？

CORSは、同一オリジンポリシー(SOP)を回避して、異なるオリジンからのリソースアクセスを許可するための仕組み。
しかし、HTMLのaタグを使用して異なるオリジンに移動する場合は、ブラウザが新しいページにナビゲートするだけであり、リソースの共有やデータの取得ではないため、CORS制約は適用されない。ナビゲーションは単にページの移動であり、リソースのクロスオリジンアクセスとは異なるため、CORSの対象外となる。

> XMLHttpRequestを使ってクロスオリジンリクエストを発行する際、デフォルトの挙動だとリクエストにクッキーが含まれません。クッキー情報を含むためには、何をする必要があるでしょうか？

XMLHttpRequestオブジェクトの`withCredentials`プロパティを`true`に設定する必要があります。これにより、クッキーや認証ヘッダーがクロスオリジンリクエストに含まれるようになる。

```javascript
var xhr = new XMLHttpRequest();
xhr.open('GET', 'https://example.com/data', true);
xhr.withCredentials = true; // クッキーを含めるために必要
xhr.send();
```

また、サーバー側でも`Access-Control-Allow-Credentials`ヘッダーを`true`に設定する必要があります。これにより、サーバーはクライアントからのクッキーを受け入れることができる。

```
Access-Control-Allow-Credentials: true
```

[オリジン間リソース共有 (CORS)/資格情報を含むリクエスト](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E8%B3%87%E6%A0%BC%E6%83%85%E5%A0%B1%E3%82%92%E5%90%AB%E3%82%80%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88)


# 課題2（クイズ）
> CORSに関するクイズを作成してください

Q1. クロスオリジンリソース共有の手段として、[JSONP (JSON with Padding) ](https://www.tohoho-web.com/ex/jsonp.html)は、CORSより優れている。Yes or No
Q2. Android と iOSのWebViewでは、`Access-Control-Allow-Origin`に対応している。Yes or No
Q3. `Access-Control-Allow-Origin`: クライアントからサーバーへのリクエストヘッダーで、オリジン間のアクセスリクエストやプリフライトリクエストのオリジンを示します。Yes or No




A1. No
JSONPはGETリクエストメソッドのみしか使えなが、CORSは他のHTTPリクエストをサポートしている。また、JSONPはXSSの問題を引き起こすリスクが有る。
[Wiki CORS vs JSONP](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing#CORS_vs_JSONP)
A2. AndroidとiOSのWebViewは、Access-Control-Allow-Originを含むCORS（オリジン間リソース共有）に対応している。
[オリジン間リソース共有 (CORS)/ブラウザーの互換性](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%83%BC%E3%81%AE%E4%BA%92%E6%8F%9B%E6%80%A7)
A3. サーバーが返すレスポンスヘッダーで、リソースへのアクセスを許可するオリジンをブラウザーに伝えるためのもの。
[オリジン間リソース共有 (CORS)/Access-Control-Allow-Origin](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#access-control-allow-origin)
