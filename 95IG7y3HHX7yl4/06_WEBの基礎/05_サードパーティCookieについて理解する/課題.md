# 課題１（質問）
> サードパーティCookieとファーストパーティCookieの違いを説明してください。

## ファーストパーティCookie
- 発行元: ユーザーが訪問したサイトのドメイン
- 主な用途:
  - ログイン状態の維持
  - 入力情報の保持
  - サイト内のユーザー行動をトラッキング

<img src="https://framerusercontent.com/images/Jcszuxqf3pAhfchMZoatZtleFE.png" width=350>

[【2024年8月版】サードパーティCookieとは？基本的な仕組み、規制への対策方法を解説](https://cozies.jp/media/23)

## サードパーティCookie
- 発行元: ユーザーが訪問したサイト以外のドメイン
- 主な用途:
  - リターゲティング広告（アクセス履歴のあるサイトの商品を別サイトに広告として表示）
  - ドメインを横断したユーザー行動のトラッキング

<img src="https://framerusercontent.com/images/49j7iE52AqfDO63oUAxqPLO8w.png" width=350>

[【2024年8月版】サードパーティCookieとは？基本的な仕組み、規制への対策方法を解説](https://cozies.jp/media/23)

## 違い(まとめ)
<img src="https://www.ebis.ne.jp/wp-content/uploads/2024/05/img_3rd-party-cookie_03.png.webp" width=400>

[サードパーティCookie（サードパーティクッキー）とは？仕組み・最新の規制を分かりやすく解説](https://www.ebis.ne.jp/column/3rd-party-cookie/)

- 発行元の違い:
  - ファーストパーティCookie: ユーザーが訪問したサイトのドメインから発行される
  - サードパーティCookie: ユーザーが訪問したサイト以外のドメインから発行される

- 用途の違い:
  - ファーストパーティCookie: ログイン状態の維持、入力情報の保持、サイト内のユーザー行動のトラッキングに使用される
  - サードパーティCookie: リターゲティング広告やドメインを横断したユーザー行動のトラッキングに使用される




> サードパーティ Cookie を用いて広告配信ネットワーク（例えばGoogle AdSense など）がどのようにユーザの訪問履歴を把握しているのか、説明してください。

<img src="https://www.ebis.ne.jp/wp-content/uploads/2022/11/image_3rd-party-cookie.png" width=400 style="background-color: white;">

1. ユーザーがサイトAを訪問すると、サイトに埋め込まれた広告用の解析タグ（JavaScript）が実行される。このタグはサードパーティCookieを利用して、ユーザーの識別IDを広告サーバーから取得し、ブラウザに保存する。この際、ユーザーがサイトAを訪問したという情報も記録される。

2. ユーザーが別のサイトBを訪問すると、広告サーバーはブラウザに保存された識別IDを使用して、ユーザーの過去の訪問履歴を基に最適化された広告を表示する。


[サードパーティCookie（サードパーティクッキー）とは？仕組み・最新の規制を分かりやすく解説](https://www.ebis.ne.jp/column/3rd-party-cookie/)


> そもそもサードパーティーCookieはどのように生成されるのでしょうか？画像埋め込みやスクリプト埋め込みなど、様々な手法を説明してください。
色々ググったのですが、情報を見つけられず以下の回答はほぼGPTです。

1. **画像埋め込み(トラッキングピクセル)**:
    1. ページ訪問: ユーザーがウェブページを訪問し、ブラウザがHTMLを解析します。
    2. ピクセル検出: ページ内のトラッキングピクセル（1x1透明画像）が検出されます。
    3. サーバーリクエスト: ブラウザがトラッキングピクセルを取得するためにサードパーティサーバーにリクエストを送信します。
    4. Cookie設定: サードパーティサーバーがレスポンスでCookieを設定し、ブラウザに送信します。

[トラッキングピクセル](https://iplogger.org/jp/tracking-pixel/)

2. **スクリプト埋め込み**:
    1. **ページ訪問**: ユーザーがウェブページを訪問し、ブラウザがページのHTMLを読み込みます。
    2. **スクリプト検出**: ページ内に埋め込まれたサードパーティのJavaScriptが検出されます。
    3. **スクリプト実行**: ブラウザがサードパーティのJavaScriptを実行します。
    4. **サーバーリクエスト**: スクリプトがサードパーティサーバーにリクエストを送信します。このリクエストには、ユーザーのブラウザ情報や訪問したページの情報が含まれることがあります。
    5. **Cookie設定**: サードパーティサーバーがレスポンスを返す際に、Cookieを設定し、ブラウザに送信します。



3. **iframe埋め込み**:
    1. **ページ訪問**: ユーザーがウェブページを訪問し、ブラウザがページのHTMLを読み込みます。
    2. **iframe検出**: ページ内に埋め込まれたサードパーティのiframeが検出されます。
    3. **コンテンツ取得**: ブラウザがiframeのコンテンツを取得するためにサードパーティサーバーにリクエストを送信します。
    4. **Cookie設定**: サードパーティサーバーがレスポンスでCookieを設定し、ブラウザに送信します。

4. **リダイレクト**:
    1. **リンククリック**: ユーザーがウェブページ上の特定のリンクをクリックします。
    2. **サードパーティサーバーへのリダイレクト**: クリックされたリンクは、まずサードパーティのサーバーにリダイレクトされます。このサーバーは、ユーザーの訪問を追跡するための中継点として機能します。
    3. **Cookie設定**: サードパーティサーバーは、ユーザーのブラウザにCookieを設定します。このCookieには、ユーザーの識別情報や訪問履歴が含まれることがあります。
    4. **最終目的地へのリダイレクト**: サードパーティサーバーは、ユーザーを最終的な目的地のウェブページにリダイレクトします。この時点で、ユーザーのブラウザにはサードパーティCookieが保存されています。

> サードパーティCookieの扱いはブラウザによってどのような差があるのでしょうか？（特にsafariは他のブラウザと挙動が異なるので、ぜひ調べてみてください！）

### Chrome
> 2024 年 1 月より、Chrome はサードパーティ Cookie のサポートを終了します。サポート終了プロセスは、2024 年第 1 四半期に 1% のテストから開始され、2024 年末までにサードパーティ Cookie が完全にサポート終了になる予定です。
Chromeは2024 年末までにサードパーティ Cookieを完全にサポート終了する予定でした。
ただ、2024/7にやっぱりサードパーティーCoolieは継続しますと方向転換しています。

[Chrome はサードパーティ Cookie のサポートを終了します](https://cloud.google.com/looker/docs/best-practices/chrome-third-party-cookie-deprecation?hl=ja)
[Google、Chromeのサードパーティクッキー廃止を撤回 2024年07月26日](https://ayudante.jp/column/2024-07-26/17-00/)
[A new path for Privacy Sandbox on the web](https://privacysandbox.com/news/privacy-sandbox-update/)

### Safari
2020年にリリースされたSafari 13.1以降、AppleはIntelligent Tracking Prevention (ITP)を強化し、すべてのサードパーティCookieをデフォルトでブロックするようになった。

### FireFox
2019年にリリースされたバージョン69で、Enhanced Tracking Protection (ETP) を導入しました。この機能により、既知のサードパーティトラッキングクッキーがプライベートブラウジングモードと標準ブラウジングモードの両方でデフォルトでブロックされるようになった。

> ドメインは同一で、ポートが異なるCookieはファーストパーティCookieでしょうか？サードパーティCookieでしょうか？（hoge.com:8080とhoge.com:8081など）
回答: ファーストパーティCookie
サードパーティーCookieは、ユーザーが訪問したサイト以外のドメインが発行元のCookieのこと。



# 課題２（実装）
## 実装
サーバー1のレスポンスにサーバー2から画像を取得するimageタグを仕込み、サーバー2からサードパーティークッキーを取得するように実装しました。

[サーバー1: ファーストパーティークッキー側](https://github.com/YamazakiYusuke/praha-challenge-hono-52-2/pull/1/files)
[サーバー2: サードパーティークッキー側](https://github.com/YamazakiYusuke/praha-challenge-hono-52-1/pull/1/files)

## エビデンス
<img src="./screen_shot.png">

## コメント
課題のヒントにあるngrokというツールは、無料だと同時に1つのサーバーしか公開できなかったので、片方をLocalhost、もう一方をngrokで公開したサーバーと言う方式で検証しました。